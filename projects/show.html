<html>
  <head>
    <!-- UTF-8 charset -->
    <meta charset="utf-8">

    <!-- Title -->
    <title>Ver Proyecto Conexión Tec</title>

    <!-- Metadata -->
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Style -->
    <link rel="stylesheet" href="../style/master/master.css">

    <!-- Scripts -->
    <script type="text/javascript" src="jquery.js"></script>  
    <!--script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script-->
    <script src="design_js/_adder.js"></script>
  </head>
    <body class="flCol-aiCen-jcCen">

    <!-- Navbar -->
    <nav class="flRow-jcBet-aiCen-fwWra">
      <div class="nav_section flRow-jcAro">
        <a class="home">Conexión Tec</a>
      </div>
      <div class="nav_section flRow-jcAro-aiCen">
        <a class="page">%LINK%</a>
        <a class="button" id = "logout">log out</a>
      </div>
    </nav>

    <!-- Show Project -->
    <div class="profile">
      <!-- Project information -->
      <div class="profile_details" id="nombreProyecto">
         <span class="ratingovrl" hidden></span>
      </div>
      <div class="flRow-jcCen">
        <div class="media_image flRow-jcBet-aiCen" id="image_carousel">
          <a class="carouse_navigation" id="carousel_left"><</a>
          <a class="carouse_navigation" id="carousel_right">></a>
        </div>
      </div>
      <div class="projectDescription">
          <h2>Project description</h2>
      </div>
      <div class="flRow-jcCen">
        <div class="media_video">
          <div class="video_container">
          </div>
        </div>
      </div>

      <!-- Project Contact -->
      <div class="profile_details">
        <div class="flRow-jcBet-aiCen-fwWra">
          <div class="details flCol-aiCen">
            <h4>Califíca el proyecto</h4>
            <div>
              <a class="material-icons stars" id="star-1">star_border</a>
              <a class="material-icons stars" id="star-2">star_border</a>
              <a class="material-icons stars" id="star-3">star_border</a>
              <a class="material-icons stars" id="star-4">star_border</a>
              <a class="material-icons stars" id="star-5">star_border</a>
            </div>
          </div>
        </div>
      </div>
      <div class="flCol-aiCen-jcCen">
        <div class="contact flCol-aiCen">
          <h4>Comments</h4>
          <textarea id="textComment" placeholder="Leave a comment"></textarea>
          <a class="button" id="addComment">Comment</a>
            <span class="idUser" hidden></span>
            <p></p>
          <div class="featured">
            <h4>Featured comments</h4>
            <div class="flRow-aiSta-jcAro-fwWra" id="commentSection">
            </div>
          </div>
        </div>
      </div>
    </div>
</body>
<script type="text/javascript">
		$(document).ready(function(){
            var idRetrieved = getUrlParameter("id");
            var verSesion = {
                "action" : "CHECKSESSION"
            };
            $.ajax({
                url : "../data/applicationLayer.php",
                type : "POST",
                data: verSesion,
                dataType : "json",
                contentType : "application/x-www-form-urlencoded",
                success: function(jsonResponse){
                    $(".idUser").attr("id",jsonResponse);
                    var newHtml = "";
                  newHtml += "<a class='page' href='../profile.html'> mi perfil</a>";
                  $('.page').replaceWith(newHtml);
                  newHtml = "";
                var verRating = {
                "action" : "VIEWRATING",
                "project_id" : idRetrieved,
                "user_id" : jsonResponse
                };    
                $.ajax({
                    url : "../data/applicationLayer.php",
                    type : "POST",
                    data: verRating,
                    dataType : "json",
                    contentType : "application/x-www-form-urlencoded",
                    success : function(jsonReceived){  
                        var ratings = jsonReceived;
                        var listaRatings = "";
                       /* for(var i = 0; i < ratings.length; i++){
                            listaRatings += ratings[i].rating;
                        }
                        $("#rating").append(listaRatings);
                        if (listaRatings !== "You haven't rated this yet") {
                            var rating = parseInt(listaRatings);
                            for (var i = 1; i <= ratings[0].rating ; i++) {
                                $(".stars > #star-" +  i).css("color", "black");
                            }
                        }*/
                        
                        /*for(var i = 1; i<= ratings[0].rating; i++){
                            $(".stars > #star-" + i).text("star");
                        }*/
                        /*$("a.material-icons").mouseenter(function(){
                          $(this).text("star").prevAll().text("star");
                        }).mouseleave(function(){
                          $(this).text("star_border").prevAll().text("star_border");
                        });*/

                    },
                    error : function(errorMessage){
                        alert(errorMessage.responseText);
                    }
                });           
                },
                error : function(errorMessage){
                    alert("please log in");
                    window.location.replace("../user/sign_in.html");
                }

            });
            var verRating2 = {
                "action" : "CHECKRATING",
                "id" : idRetrieved
            };
            $.ajax({
               url: "../data/applicationLayer.php",
               type: "POST",
               data: verRating2,
               dataType: "json",
               contentType: "application/x-www-form-urlencoded",
               success: function(jsonResponse){
                   $(".ratingovrl").attr("id",jsonResponse[0].rating);
               },
               error : function(errorMessage){
                   console.log("error");
               }
            });
            var verProyecto = { 
                "action" : "VIEWPROJECT",
                "id" :   idRetrieved                
                               };
            var verComentarios = {
                "action" : "VIEWCOMMENTS",
                "id" :   idRetrieved
                               };

        //MANEJO DE CARRUSEL DE IMAGENES
        var array_index = 0;
        $("#carousel_right").click(function(){
          if (array_index === image_array.length - 1) {
            array_index = 0;
          }
          else {
            array_index = array_index + 1;
          }
          $("#image_carousel").css("background-image", "url("+ image_array[array_index] +")");
        });

        $("#carousel_left").click(function(){
          if (array_index === 0) {
            array_index = image_array.length - 1;
          }
          else {
            array_index = array_index - 1;
          }
          $("#image_carousel").css("background-image", "url("+ image_array[array_index] +")");
        });   
        //LOGICA PARA EL HOVER DE ESTRELLAS    
        $("a.material-icons").mouseenter(function(){
          $(this).text("star").prevAll().text("star");
        }).mouseleave(function(){
          $(this).text("star_border").prevAll().text("star_border");
        });
            
        var idRetrieved = getUrlParameter("id");
        $("#readIdOfProject").text(getUrlParameter("id"));	
    
        $.ajax({
            url : "../data/applicationLayer.php",
            type : "POST",
            data: verProyecto,
            dataType : "json",
            contentType : "application/x-www-form-urlencoded",
            success : function(jsonReceived){  
                var projects = jsonReceived;
                var listaProjects = "";
                var projectsID = [];
                var pName = "";
                pName += '<h1>' + projects[0].pNombre +'</h1>' +
                          '<div class="flRow-jcBet-aiSta">' +
                              '<div class="details">' +
                                '<h4>' + projects[0].primerNombre + ' '+ projects[0].segNombre + '</h4>' +
                                    '<p>' + projects[0].pArea +'</p>' + 
                                    '<span>Calificación: ' + $(".ratingovrl").attr("id") + '/5</span>' +
                              '</div>' +
                        '</div>';
                $("#nombreProyecto").append(pName);
                image_array=[projects[0].pImagen1,
                            projects[0].pImagen2];
                var array_index = 0;
                $("#image_carousel").css("background-image", "url(" + image_array[array_index] + ")");
                /*var img = "";
                
                img += '<div class="media_image flRow-jcBet-aiCen" id="image_carousel">' +
                        '<a class="carouse_navigation" id="carousel_left"><</a>' +
                        '<a class="carouse_navigation" id="carousel_right">></a>' +
                        '</div>';
                $().append(img);*/
                
                var pDescripcion = "";
                pDescripcion += '<p>' + projects[0].pDescripcion +'</p>';
                $(".projectDescription").append(pDescripcion);
                
                var videoURL = projects[0].pVideo;
                var videoId = getId(videoURL);
                var videoAppend = "";
                videoAppend += '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + videoId + '" frameborder="0" allowfullscreen></iframe>';
                $(".video_container").append(videoAppend);
                
                
            },
            error : function(errorMessage){
                alert(errorMessage.responseText);
            }
        });
        $.ajax({
            url : "../data/applicationLayer.php",
            type : "POST",
            data: verComentarios,
            dataType : "json",
            contentType : "application/x-www-form-urlencoded",
            success : function(jsonReceived){  
                var comments = jsonReceived;
                var listaComments = "";
                var commentsID = [];
                for(var i = 0; i < comments.length; i++){
                    listaComments +='<div class="comment card">' +
                                       '<strong>' + comments[i].primerNombre + ' ' + comments[i].segNombre + '</strong>'+
                                       '<p>' + comments[i].date + '</p>'+ 
                                       '<p>' + comments[i].comment + '</p>'+
                                    '</div>'; 
                }
                $("#commentSection").append(listaComments);
            },
            error : function(errorMessage){
                alert(errorMessage.responseText);
            }
        });
        $('.stars').on('click', function() {
            var stars = parseInt($(this).attr('id').slice(-1));
            var actualizarRating = {
                "action" : "UPDATERATING",
                "project_id" : idRetrieved,
                "rating" : stars,
                "userID" : $(".idUser").attr("id")
            };
            $.ajax({ 
                url: "../data/applicationLayer.php",
                type: "POST",
                data: actualizarRating,
                success: function(data){
                    // Reload page after adding comment
                    alert("Calificación Registrada");
                }
            });
        });
        $('#addComment').on('click', function() {
           var $this = $(this);
           var alreadyClicked = $this.data('clicked');
           if (alreadyClicked) {
              return false;
           }
           $this.data('clicked', true);
            
            var comment = $('#textComment').val();
            var insertarCommentario = {
                "action" : "INSERTCOMMENT",
                "project_id" : idRetrieved,
                "text" : comment,
                "userID": $(".idUser").attr("id")
            };
            var getuserName = {
                "action" : "GETUSERNAME",
                "userID" : $(".idUser").attr("id")
            }
            $.ajax({ 
                url: "../data/applicationLayer.php",
                type: "POST",
                data: insertarCommentario,
                success: function(data){
                    // Reload page after adding comment
                    /*var listaComments = "";
                    var user = data;
                    listaComments +='<div class="comment card">' +
                                       '<strong>' + user["id"] + '</strong>'+
                                       '<p>' + comment + '</p>'+
                                    '</div>';
                    $("#commentSection").append(listaComments);
                    */
                    alert("Comentario registrado");
                    location.reload();
                },
                error : function(errorMsg){
                    console.log(errorMsg);
                }
            });
        });
    });

		function getUrlParameter(paramName){
				var results = new RegExp('[\?&]' + paramName + '=([^&#]*)').exec(window.location.href);
				return results[1] || 0;
			}
        function getId(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);

            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return 'error';
            }
        }
	</script>
</html>